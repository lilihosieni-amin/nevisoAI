<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>نویسو - جزوه‌های دفتر</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body data-theme="light">
    <div class="app-container">
        {% set active_page = 'notebooks' %}
        {% include 'components/sidebar.html' %}

        <main class="main-content-wrapper">
            <div class="content-container">
                <div class="notes-header">
                    <button class="back-button" onclick="window.location.href='/notebooks'">→ بازگشت به دفترها</button>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="chat-button" id="chat-notebook-btn" onclick="openNotebookChat()" style="display: flex; align-items: center; gap: 0.5rem; background: var(--bg-primary); color: var(--text-primary); border: 2px solid var(--border-color); padding: 0.5rem 1rem; border-radius: var(--radius); cursor: pointer; font-family: inherit; font-size: 0.9rem; font-weight: 500; transition: all 0.2s ease; box-shadow: var(--shadow-hard);">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                            </svg>
                            گفتگو با دفتر
                        </button>
                        <button class="export-button" id="export-notebook-btn">خروجی PDF دفتر</button>
                    </div>
                </div>
                <div class="page-header" style="justify-content: flex-start;">
                    <h1 class="page-title" id="notebook-title"></h1>
                </div>
                <div class="notes-list" id="notes-list"></div>
            </div>
        </main>
    </div>

    {% include 'components/mobile_nav.html' %}
    
    <script src="/static/js/api.js"></script>
    <script src="/static/js/common.js"></script>
    <script>
        let notebookId = null;
        let notebookTitle = '';
        let refreshInterval = null;

        document.addEventListener('DOMContentLoaded', function() {
            setupSidebarToggle();
            setupThemeSwitcher();
            loadNotes();
        });

        async function loadNotes() {
            const urlParams = new URLSearchParams(window.location.search);
            notebookId = urlParams.get('notebook_id');

            if (!notebookId) {
                window.location.href = '/notebooks';
                return;
            }

            const notesList = document.getElementById('notes-list');
            const notebookTitleEl = document.getElementById('notebook-title');
            showLoading(notesList);
            notebookTitleEl.textContent = 'در حال بارگذاری...';
            
            try {
                // Fetch notebook details and notes in parallel
                const [notebook, notes] = await Promise.all([
                    notebooksAPI.getById(notebookId),
                    notesAPI.getAll(notebookId)
                ]);

                notebookTitle = notebook.title;
                notebookTitleEl.textContent = notebook.title;
                renderNotes(notes);

                const exportBtn = document.getElementById('export-notebook-btn');
                exportBtn.onclick = () => exportNotebook(notebook.title);

            } catch (error) {
                showError(notesList, 'خطا در بارگذاری جزوه‌ها');
                notebookTitleEl.textContent = 'خطا';
            }
        }

        function renderNotes(notes) {
            const notesList = document.getElementById('notes-list');
            if (notes.length === 0) {
                notesList.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">این دفتر هنوز جزوه‌ای ندارد.</div>';
                stopAutoRefresh();
                return;
            }

            notesList.innerHTML = notes.map(note => {
                const statusMessages = {
                    processing: note.retry_count > 0 ? `در حال تلاش مجدد (${note.retry_count}/3)` : 'در حال پردازش',
                    completed: 'کامل شده',
                    failed: 'پردازش ناموفق'
                };

                // Determine if note can be opened
                const canOpen = note.status === 'completed';
                const cursorStyle = canOpen ? 'cursor: pointer;' : 'cursor: not-allowed; opacity: 0.7;';
                const onClickAttr = canOpen ? `onclick="openNote(${note.id}, '${note.status}')"` : `onclick="handleLockedNote('${note.status}', ${JSON.stringify(note.error_message || '').replace(/'/g, "\\'")})"`;

                // Show error message if failed
                const errorDisplay = note.status === 'failed' && note.error_message
                    ? `<div class="note-error-message">${note.error_message}</div>`
                    : '';

                // Show processing spinner
                const processingIcon = note.status === 'processing'
                    ? '<span class="processing-spinner"></span>'
                    : '';

                // Only show status badge for processing and failed notes
                const statusBadge = (note.status === 'processing' || note.status === 'failed')
                    ? `<span class="note-status ${note.status}" data-status="${note.status}">${statusMessages[note.status] || note.status}</span>`
                    : '';

                // Truncate title if too long
                let displayTitle = note.title;
                if (displayTitle.length > 100) {
                    displayTitle = displayTitle.substring(0, 100) + '...';
                }

                // Extract preview text from HTML content (only for completed notes)
                let previewText = '';
                if (note.status === 'completed' && note.user_edited_text) {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = note.user_edited_text;
                    const textContent = tempDiv.textContent || tempDiv.innerText || '';
                    previewText = textContent.trim().substring(0, 100);
                    if (textContent.length > 100) previewText += '...';
                }

                return `
                <div class="note-card" data-note-id="${note.id}" ${onClickAttr} style="${cursorStyle}">
                    <div class="note-header">
                        <div class="note-header-main">
                            <div class="note-title" title="${note.title}">${processingIcon} ${displayTitle}</div>
                            <div class="note-date">${note.session_date ? formatDate(note.session_date) : ''}</div>
                            ${previewText ? `<div class="note-preview">${previewText}</div>` : ''}
                        </div>
                         <div class="note-header-meta">
                            <div class="note-menu-container">
                                <button class="note-menu-btn" onclick="event.stopPropagation(); toggleNoteMenu(${note.id});" title="منو">
                                    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                                        <circle cx="10" cy="4" r="1.5"/>
                                        <circle cx="10" cy="10" r="1.5"/>
                                        <circle cx="10" cy="16" r="1.5"/>
                                    </svg>
                                </button>
                                <div class="note-menu-dropdown" id="note-menu-${note.id}">
                                    <button class="note-menu-item delete" onclick="event.stopPropagation(); deleteNote(${note.id}, '${note.title.replace(/'/g, "\\'")}');">
                                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                            <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                            <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                        </svg>
                                        حذف جزوه
                                    </button>
                                </div>
                            </div>
                            ${statusBadge}
                        </div>
                    </div>
                    <div class="note-error-container">${errorDisplay}</div>
                </div>
            `}).join('');

            // Start auto-refresh only if there are processing notes
            const hasProcessing = notes.some(n => n.status === 'processing');
            if (hasProcessing) {
                startAutoRefresh();
            } else {
                stopAutoRefresh();
            }
        }

        // Auto-refresh functions that update only status without reloading entire page
        function startAutoRefresh() {
            if (refreshInterval) return; // Already running

            refreshInterval = setInterval(async () => {
                try {
                    const notes = await notesAPI.getAll(notebookId);
                    updateNoteStatuses(notes);

                    // Stop refreshing if no processing notes remain
                    const hasProcessing = notes.some(n => n.status === 'processing');
                    if (!hasProcessing) {
                        stopAutoRefresh();
                    }
                } catch (error) {
                    console.error('Auto-refresh error:', error);
                }
            }, 3000); // Check every 3 seconds
        }

        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }

        // Update only the status and error messages without reloading entire list
        function updateNoteStatuses(notes) {
            notes.forEach(note => {
                const noteCard = document.querySelector(`.note-card[data-note-id="${note.id}"]`);
                if (!noteCard) return;

                const statusElement = noteCard.querySelector('.note-status');
                const currentStatus = statusElement.getAttribute('data-status');

                // Only update if status changed
                if (currentStatus !== note.status) {
                    const statusMessages = {
                        processing: note.retry_count > 0 ? `در حال تلاش مجدد (${note.retry_count}/3)` : 'در حال پردازش',
                        completed: 'کامل شده',
                        failed: 'پردازش ناموفق'
                    };

                    // Update status badge
                    statusElement.className = `note-status ${note.status}`;
                    statusElement.setAttribute('data-status', note.status);
                    statusElement.textContent = statusMessages[note.status] || note.status;

                    // Update cursor and onclick based on new status
                    const canOpen = note.status === 'completed';
                    noteCard.style.cursor = canOpen ? 'pointer' : 'not-allowed';
                    noteCard.style.opacity = canOpen ? '1' : '0.7';

                    if (canOpen) {
                        noteCard.setAttribute('onclick', `openNote(${note.id}, '${note.status}')`);
                    } else {
                        noteCard.setAttribute('onclick', `handleLockedNote('${note.status}', ${JSON.stringify(note.error_message || '').replace(/'/g, "\\'")})`);
                    }

                    // Update/remove processing spinner
                    const titleElement = noteCard.querySelector('.note-title');
                    const currentSpinner = titleElement.querySelector('.processing-spinner');

                    if (note.status === 'processing' && !currentSpinner) {
                        titleElement.innerHTML = '<span class="processing-spinner">⏳</span> ' + titleElement.textContent;
                    } else if (note.status !== 'processing' && currentSpinner) {
                        currentSpinner.remove();
                    }

                    // Update error message
                    const errorContainer = noteCard.querySelector('.note-error-container');
                    if (note.status === 'failed' && note.error_message) {
                        errorContainer.innerHTML = `<div class="note-error-message">❌ ${note.error_message}</div>`;
                    } else {
                        errorContainer.innerHTML = '';
                    }

                    // Show toast notification for status change
                    if (note.status === 'completed') {
                        showToast(`جزوه "${note.title}" با موفقیت پردازش شد ✅`, 'success');
                    } else if (note.status === 'failed') {
                        showToast(`پردازش جزوه "${note.title}" ناموفق بود ❌`, 'error');
                    }
                }
            });
        }

        function openNote(noteId, status) {
            if (status === 'completed') {
                window.location.href = `/editor?note_id=${noteId}`;
            }
        }

        function openNotebookChat() {
            if (notebookId) {
                window.location.href = `/chat?notebook_id=${notebookId}`;
            }
        }

        function handleLockedNote(status, errorMessage) {
            if (status === 'processing') {
                showToast('این جزوه در حال پردازش است. لطفاً صبر کنید...', 'info');
            } else if (status === 'failed') {
                const message = errorMessage || 'پردازش این جزوه با خطا مواجه شده است.';
                showToast(message, 'error');
            }
        }

        async function exportNotebook(title) {
            const btn = document.getElementById('export-notebook-btn');
            btn.disabled = true;
            btn.textContent = 'در حال آماده‌سازی...';
            try {
                const blob = await notebooksAPI.exportPDF(notebookId);
                downloadBlob(blob, `${title}.pdf`);
                showToast('PDF با موفقیت دانلود شد', 'success');
            } catch (error) {
                showToast(error.message || 'خطا در دانلود PDF. ممکن است هیچ جزوه کاملی در این دفتر نباشد.', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'خروجی PDF دفتر';
            }
        }

        function toggleNoteMenu(noteId) {
            const menu = document.getElementById(`note-menu-${noteId}`);
            const isOpen = menu.classList.contains('show');

            // Close all other menus
            document.querySelectorAll('.note-menu-dropdown.show').forEach(m => {
                m.classList.remove('show');
            });

            // Toggle current menu
            if (!isOpen) {
                menu.classList.add('show');
            }
        }

        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.note-menu-container')) {
                document.querySelectorAll('.note-menu-dropdown.show').forEach(m => {
                    m.classList.remove('show');
                });
            }
        });

        async function deleteNote(noteId, noteTitle) {
            // Close the menu
            document.getElementById(`note-menu-${noteId}`).classList.remove('show');

            const confirmed = confirm(`آیا از حذف جزوه "${noteTitle}" اطمینان دارید؟\n\nاین جزوه از لیست حذف می‌شود.`);
            if (!confirmed) return;

            try {
                await notesAPI.delete(noteId);
                showToast('جزوه با موفقیت حذف شد', 'success');

                // Remove note card from DOM
                const noteCard = document.querySelector(`.note-card[data-note-id="${noteId}"]`);
                if (noteCard) {
                    noteCard.remove();
                }

                // Check if list is now empty
                const notesList = document.getElementById('notes-list');
                const remainingNotes = notesList.querySelectorAll('.note-card');
                if (remainingNotes.length === 0) {
                    notesList.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">این دفتر هنوز جزوه‌ای ندارد.</div>';
                }
            } catch (error) {
                showToast(error.message || 'خطا در حذف جزوه', 'error');
            }
        }
    </script>
</body>
</html>